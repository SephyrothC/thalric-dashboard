{% extends "base.html" %}

{% block title %}Sorts - {{ character.character_info.name }}{% endblock %}

{% block content %}
<h1 style="text-align: center; color: var(--primary-gold); margin-bottom: 20px;">‚ú® Grimoire de Sorts</h1>

<!-- Barre de recherche et filtres -->
<div style="background: var(--medium-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--border-color);">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="spell-search" placeholder="üîç Rechercher un sort..."
            style="flex: 1; min-width: 250px; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-light); font-size: 1rem;">

        <select id="filter-level"
            style="padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-light); font-size: 1rem;">
            <option value="all">üìö Tous les niveaux</option>
            <option value="0">üåü Cantrips</option>
            <option value="1">1Ô∏è‚É£ Niveau 1</option>
            <option value="2">2Ô∏è‚É£ Niveau 2</option>
            <option value="3">3Ô∏è‚É£ Niveau 3</option>
            <option value="4">4Ô∏è‚É£ Niveau 4</option>
        </select>

        <select id="filter-type"
            style="padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-light); font-size: 1rem;">
            <option value="all">üéØ Tous les sorts</option>
            <option value="oath">‚≠ê Serment uniquement</option>
            <option value="normal">üìñ Sorts normaux</option>
        </select>

        <button onclick="toggleAllSpells()" class="btn btn-info" style="white-space: nowrap;">
            <span id="toggle-text">‚ûï Tout D√©plier</span>
        </button>
    </div>
</div>

<!-- Statistiques rapides -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="quick-stat">
        <div class="quick-stat-value" id="total-spells-count">0</div>
        <div class="quick-stat-label">Sorts Totaux</div>
    </div>
    <div class="quick-stat">
        <div class="quick-stat-value" id="available-slots-count">0</div>
        <div class="quick-stat-label">Slots Disponibles</div>
    </div>
    <div class="quick-stat">
        <div class="quick-stat-value">{{ character.spellcasting.spell_save_dc }}</div>
        <div class="quick-stat-label">DD de Sauvegarde</div>
    </div>
    <div class="quick-stat">
        <div class="quick-stat-value">+{{ character.spellcasting.spell_attack_bonus }}</div>
        <div class="quick-stat-label">Bonus d'Attaque</div>
    </div>
</div>

<!-- Emplacements de sorts en horizontal -->
<div style="background: var(--medium-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--border-color);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: var(--primary-gold); margin: 0;">üíé Emplacements de Sorts</h2>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="color: var(--secondary-gold); font-size: 0.9rem;">
                <strong>Capacit√©: Charisme</strong>
            </div>
            <button onclick="restoreAllSlots()" class="btn btn-success">
                ‚ö° Repos Long
            </button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <!-- Niveau 1 -->
        <div class="spell-slot-container-horizontal" data-level="1">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="color: var(--primary-gold); margin: 0; font-size: 1.1rem;">Niveau 1</h3>
                    <div style="font-size: 1.2rem;">
                        <span id="spell-slots-1" class="slot-counter" style="color: var(--primary-gold); font-weight: bold;">{{
                            character.spellcasting.spell_slots_current['1'] }}</span>
                        <span style="color: var(--text-muted);">/</span>
                        <span style="color: var(--text-light);">{{ character.spellcasting.spell_slots['1'] }}</span>
                    </div>
                </div>
                <div class="slot-progress-bar">
                    <div class="slot-progress-fill" id="progress-1" data-level="1"
                        style="width: {{ (character.spellcasting.spell_slots_current['1'] / character.spellcasting.spell_slots['1'] * 100) }}%; background: var(--primary-gold);"></div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    {% for i in range(character.spellcasting.spell_slots['1']) %}
                    <div class="spell-slot" data-level="1" data-slot="{{ i + 1 }}" onclick="toggleSlot(1, {{ i + 1 }})"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--primary-gold); cursor: pointer; transition: all 0.2s;
                             {% if i < character.spellcasting.spell_slots_current['1'] %}background: var(--primary-gold);{% else %}background: transparent;{% endif %}">
                    </div>
                    {% endfor %}
                </div>
            </div>

        <!-- Niveau 2 -->
        <div class="spell-slot-container-horizontal" data-level="2">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="color: var(--info-blue); margin: 0; font-size: 1.1rem;">Niveau 2</h3>
                    <div style="font-size: 1.2rem;">
                        <span id="spell-slots-2" class="slot-counter" style="color: var(--info-blue); font-weight: bold;">{{
                            character.spellcasting.spell_slots_current['2'] }}</span>
                        <span style="color: var(--text-muted);">/</span>
                        <span style="color: var(--text-light);">{{ character.spellcasting.spell_slots['2'] }}</span>
                    </div>
                </div>
                <div class="slot-progress-bar">
                    <div class="slot-progress-fill" id="progress-2" data-level="2"
                        style="width: {{ (character.spellcasting.spell_slots_current['2'] / character.spellcasting.spell_slots['2'] * 100) }}%; background: var(--info-blue);"></div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    {% for i in range(character.spellcasting.spell_slots['2']) %}
                    <div class="spell-slot" data-level="2" data-slot="{{ i + 1 }}" onclick="toggleSlot(2, {{ i + 1 }})"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--info-blue); cursor: pointer; transition: all 0.2s;
                             {% if i < character.spellcasting.spell_slots_current['2'] %}background: var(--info-blue);{% else %}background: transparent;{% endif %}">
                    </div>
                    {% endfor %}
                </div>
            </div>

        <!-- Niveau 3 -->
        <div class="spell-slot-container-horizontal" data-level="3">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="color: var(--warning-orange); margin: 0; font-size: 1.1rem;">Niveau 3</h3>
                    <div style="font-size: 1.2rem;">
                        <span id="spell-slots-3" class="slot-counter" style="color: var(--warning-orange); font-weight: bold;">{{
                            character.spellcasting.spell_slots_current['3'] }}</span>
                        <span style="color: var(--text-muted);">/</span>
                        <span style="color: var(--text-light);">{{ character.spellcasting.spell_slots['3'] }}</span>
                    </div>
                </div>
                <div class="slot-progress-bar">
                    <div class="slot-progress-fill" id="progress-3" data-level="3"
                        style="width: {{ (character.spellcasting.spell_slots_current['3'] / character.spellcasting.spell_slots['3'] * 100) }}%; background: var(--warning-orange);"></div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    {% for i in range(character.spellcasting.spell_slots['3']) %}
                    <div class="spell-slot" data-level="3" data-slot="{{ i + 1 }}" onclick="toggleSlot(3, {{ i + 1 }})"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--warning-orange); cursor: pointer; transition: all 0.2s;
                             {% if i < character.spellcasting.spell_slots_current['3'] %}background: var(--warning-orange);{% else %}background: transparent;{% endif %}">
                    </div>
                    {% endfor %}
                </div>
            </div>

        <!-- Niveau 4 -->
        <div class="spell-slot-container-horizontal" data-level="4">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3 style="color: var(--danger-red); margin: 0; font-size: 1.1rem;">Niveau 4</h3>
                    <div style="font-size: 1.2rem;">
                        <span id="spell-slots-4" class="slot-counter" style="color: var(--danger-red); font-weight: bold;">{{
                            character.spellcasting.spell_slots_current['4'] }}</span>
                        <span style="color: var(--text-muted);">/</span>
                        <span style="color: var(--text-light);">{{ character.spellcasting.spell_slots['4'] }}</span>
                    </div>
                </div>
                <div class="slot-progress-bar">
                    <div class="slot-progress-fill" id="progress-4" data-level="4"
                        style="width: {{ (character.spellcasting.spell_slots_current['4'] / character.spellcasting.spell_slots['4'] * 100) }}%; background: var(--danger-red);"></div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    {% for i in range(character.spellcasting.spell_slots['4']) %}
                    <div class="spell-slot" data-level="4" data-slot="{{ i + 1 }}" onclick="toggleSlot(4, {{ i + 1 }})"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--danger-red); cursor: pointer; transition: all 0.2s;
                             {% if i < character.spellcasting.spell_slots_current['4'] %}background: var(--danger-red);{% else %}background: transparent;{% endif %}">
                    </div>
                    {% endfor %}
                </div>
            </div>
    </div>

    <!-- Contr√¥les niveau de sort -->
    <div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 2px solid var(--border-color);">
        <label style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span style="color: var(--text-light); font-weight: bold;">Lancer au niveau:</span>
            <select id="spell-level-select"
                style="background: var(--dark-bg); border: 2px solid var(--primary-gold); color: var(--text-light); padding: 10px 20px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer;">
                <option value="1">Niveau 1</option>
                <option value="2">Niveau 2</option>
                <option value="3">Niveau 3</option>
                <option value="4">Niveau 4</option>
            </select>
        </label>
    </div>
</div>

<!-- Tous les sorts -->
<div class="stats-grid">
    <div class="stat-card" style="grid-column: 1 / -1;">
        <h2 class="card-title">üìñ Liste des Sorts</h2>
        <div class="card-content">
            <div id="spells-container">
                <!-- Cantrips -->
                <div class="spell-item" data-level="0" data-type="normal" data-name="Light">
                    <div class="spell-header" onclick="toggleSpellDetails(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">üåü</span>
                            <div>
                                <h3 style="margin: 0; color: var(--primary-gold);">{{ character.spells.cantrips.light.name }}</h3>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Cantrip ‚Ä¢ {{ character.spells.cantrips.light.school | title }}
                                </div>
                            </div>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="spell-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; font-size: 0.9rem;">
                            <div><strong>Temps:</strong> {{ character.spells.cantrips.light.casting_time }}</div>
                            <div><strong>Port√©e:</strong> {{ character.spells.cantrips.light.range }}</div>
                            <div><strong>Dur√©e:</strong> {{ character.spells.cantrips.light.duration }}</div>
                        </div>
                        <p style="font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px;">
                            {{ character.spells.cantrips.light.description }}
                        </p>
                        <button class="btn btn-info spell-cast-btn" onclick="castCantrip('light')" style="width: 100%;">
                            ‚ú® Lancer Light (Cantrip illimit√©)
                        </button>
                    </div>
                </div>

                <!-- Sorts Niveau 1 -->
                {% set level_1_spells = [
                    ('protection_from_evil_and_good', character.spells.level_1.protection_from_evil_and_good, 'üõ°Ô∏è', 'var(--success-green)', true),
                    ('sanctuary', character.spells.level_1.sanctuary, 'üèõÔ∏è', 'var(--info-blue)', true),
                    ('bless', character.spells.level_1.bless, '‚ú®', 'var(--primary-gold)', false),
                    ('cure_wounds', character.spells.level_1.cure_wounds, 'üíö', 'var(--success-green)', false),
                    ('shield_of_faith', character.spells.level_1.shield_of_faith, 'üõ°Ô∏è', 'var(--primary-gold)', false)
                ] %}
                {% for spell_id, spell_data, icon, color, is_oath in level_1_spells %}
                <div class="spell-item" data-level="1" data-type="{{ 'oath' if is_oath else 'normal' }}" data-name="{{ spell_data.name }}">
                    <div class="spell-header" onclick="toggleSpellDetails(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">{{ icon }}</span>
                            <div>
                                <h3 style="margin: 0; color: {{ color }};">
                                    {{ spell_data.name }}
                                    {% if is_oath %}<span class="oath-badge">SERMENT</span>{% endif %}
                                </h3>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Niveau 1 ‚Ä¢ {{ spell_data.school | title if spell_data.school else 'Abjuration' }}
                                </div>
                            </div>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="spell-details">
                        <p style="font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px;">
                            {{ spell_data.description }}
                        </p>
                        <button class="btn btn-small spell-cast-btn" onclick="castSpell('{{ spell_id }}', false)" style="width: 100%; background: {{ color }};">
                            {{ icon }} Lancer (Niveau 1)
                        </button>
                    </div>
                </div>
                {% endfor %}

                <!-- Sorts Niveau 2 -->
                {% set level_2_spells = [
                    ('lesser_restoration', character.spells.level_2.lesser_restoration, '‚ú®', 'var(--success-green)', true),
                    ('zone_of_truth', character.spells.level_2.zone_of_truth, 'üëÅÔ∏è', 'var(--info-blue)', true),
                    ('aid', character.spells.level_2.aid, 'üí™', 'var(--warning-orange)', false),
                    ('find_steed', character.spells.level_2.find_steed, 'üêé', 'var(--primary-gold)', false)
                ] %}
                {% for spell_id, spell_data, icon, color, is_oath in level_2_spells %}
                <div class="spell-item" data-level="2" data-type="{{ 'oath' if is_oath else 'normal' }}" data-name="{{ spell_data.name }}">
                    <div class="spell-header" onclick="toggleSpellDetails(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">{{ icon }}</span>
                            <div>
                                <h3 style="margin: 0; color: {{ color }};">
                                    {{ spell_data.name }}
                                    {% if is_oath %}<span class="oath-badge">SERMENT</span>{% endif %}
                                </h3>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Niveau 2 ‚Ä¢ {{ spell_data.school | title if spell_data.school else 'Abjuration' }}
                                </div>
                            </div>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="spell-details">
                        <p style="font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px;">
                            {{ spell_data.description }}
                        </p>
                        <button class="btn btn-small spell-cast-btn" onclick="castSpell('{{ spell_id }}', false)" style="width: 100%; background: {{ color }};">
                            {{ icon }} Lancer (Niveau 2)
                        </button>
                    </div>
                </div>
                {% endfor %}

                <!-- Sorts Niveau 3 -->
                {% set level_3_spells = [
                    ('dispel_magic', character.spells.level_3.dispel_magic, 'üö´', 'var(--danger-red)', true),
                    ('beacon_of_hope', character.spells.level_3.beacon_of_hope, '‚ú®', 'var(--success-green)', true),
                    ('remove_curse', character.spells.level_3.remove_curse, 'üîì', 'var(--info-blue)', true),
                    ('revivify', character.spells.level_3.revivify, 'üíé', 'var(--warning-orange)', false),
                    ('aura_of_vitality', character.spells.level_3.aura_of_vitality, 'üíö', 'var(--success-green)', false),
                    ('magic_circle', character.spells.level_3.magic_circle, '‚≠ï', 'var(--primary-gold)', false)
                ] %}
                {% for spell_id, spell_data, icon, color, is_oath in level_3_spells %}
                <div class="spell-item" data-level="3" data-type="{{ 'oath' if is_oath else 'normal' }}" data-name="{{ spell_data.name }}">
                    <div class="spell-header" onclick="toggleSpellDetails(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">{{ icon }}</span>
                            <div>
                                <h3 style="margin: 0; color: {{ color }};">
                                    {{ spell_data.name }}
                                    {% if is_oath %}<span class="oath-badge">SERMENT</span>{% endif %}
                                </h3>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Niveau 3 ‚Ä¢ {{ spell_data.school | title if spell_data.school else 'Abjuration' }}
                                </div>
                            </div>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="spell-details">
                        <p style="font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px;">
                            {{ spell_data.description }}
                        </p>
                        <button class="btn btn-small spell-cast-btn" onclick="castSpell('{{ spell_id }}', false)" style="width: 100%; background: {{ color }};">
                            {{ icon }} Lancer (Niveau 3){% if 'revivify' in spell_id %} - 300 PO{% elif 'magic_circle' in spell_id %} - 100 PO{% endif %}
                        </button>
                    </div>
                </div>
                {% endfor %}

                <!-- Sorts Niveau 4 -->
                {% set level_4_spells = [
                    ('aura_of_life', character.spells.level_4.aura_of_life, 'üíö', 'var(--success-green)', true),
                    ('guardian_of_faith', character.spells.level_4.guardian_of_faith, 'üëº', 'var(--primary-gold)', true)
                ] %}
                {% for spell_id, spell_data, icon, color, is_oath in level_4_spells %}
                <div class="spell-item" data-level="4" data-type="{{ 'oath' if is_oath else 'normal' }}" data-name="{{ spell_data.name }}">
                    <div class="spell-header" onclick="toggleSpellDetails(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">{{ icon }}</span>
                            <div>
                                <h3 style="margin: 0; color: {{ color }};">
                                    {{ spell_data.name }}
                                    {% if is_oath %}<span class="oath-badge">SERMENT</span>{% endif %}
                                </h3>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Niveau 4 ‚Ä¢ {{ spell_data.school | title if spell_data.school else 'Abjuration' }}
                                </div>
                            </div>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="spell-details">
                        <p style="font-size: 0.95rem; color: var(--text-light); margin-bottom: 15px;">
                            {{ spell_data.description }}
                        </p>
                        <button class="btn btn-small spell-cast-btn" onclick="castSpell('{{ spell_id }}', false)" style="width: 100%; background: {{ color }};">
                            {{ icon }} Lancer (Niveau 4)
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="no-results" style="display: none; text-align: center; padding: 40px; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                <div style="font-size: 1.2rem;">Aucun sort trouv√©</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">Essayez une autre recherche ou changez les filtres</div>
            </div>
        </div>
    </div>
</div>

<style>
.quick-stat {
    background: var(--dark-bg);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.quick-stat:hover {
    border-color: var(--primary-gold);
    transform: translateY(-2px);
}

.quick-stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--primary-gold);
    margin-bottom: 5px;
}

.quick-stat-label {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.spell-slot-container-horizontal {
    background: var(--dark-bg);
    padding: 15px;
    border-radius: 10px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.spell-slot-container-horizontal:hover {
    border-color: var(--primary-gold);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.slot-progress-bar {
    width: 100%;
    height: 12px;
    background: var(--medium-bg);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.slot-progress-fill {
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 6px;
}

.spell-slot:hover {
    transform: scale(1.2);
    box-shadow: 0 0 10px currentColor;
}

.spell-item {
    background: var(--dark-bg);
    border-radius: 10px;
    margin-bottom: 12px;
    border: 2px solid var(--border-color);
    overflow: hidden;
    transition: all 0.3s ease;
}

.spell-item:hover {
    border-color: var(--primary-gold);
    transform: translateX(5px);
}

.spell-header {
    padding: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s ease;
}

.spell-header:hover {
    background: var(--medium-bg);
}

.spell-details {
    padding: 0 15px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
}

.spell-item.expanded .spell-details {
    max-height: 500px;
    padding: 15px;
}

.spell-item.expanded .expand-icon {
    transform: rotate(180deg);
}

.expand-icon {
    color: var(--primary-gold);
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.oath-badge {
    font-size: 0.65rem;
    background: var(--secondary-gold);
    color: var(--dark-bg);
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: bold;
    margin-left: 8px;
    letter-spacing: 0.5px;
}

.spell-cast-btn {
    animation: pulse-glow 2s infinite;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); }
    50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
}

.spell-cast-btn:hover {
    animation: none;
    box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
    transform: scale(1.02);
}

.slot-counter {
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let allExpanded = false;

// Fonction pour basculer les d√©tails d'un sort
function toggleSpellDetails(header) {
    const spellItem = header.closest('.spell-item');
    spellItem.classList.toggle('expanded');
}

// Fonction pour tout d√©plier/replier
function toggleAllSpells() {
    const spells = document.querySelectorAll('.spell-item');
    const toggleText = document.getElementById('toggle-text');

    allExpanded = !allExpanded;

    spells.forEach(spell => {
        if (!spell.style.display || spell.style.display !== 'none') {
            if (allExpanded) {
                spell.classList.add('expanded');
            } else {
                spell.classList.remove('expanded');
            }
        }
    });

    toggleText.textContent = allExpanded ? '‚ûñ Tout Replier' : '‚ûï Tout D√©plier';
}

// Fonction de recherche et filtres
function filterSpells() {
    const searchTerm = document.getElementById('spell-search').value.toLowerCase();
    const levelFilter = document.getElementById('filter-level').value;
    const typeFilter = document.getElementById('filter-type').value;

    const spells = document.querySelectorAll('.spell-item');
    let visibleCount = 0;

    spells.forEach(spell => {
        const name = spell.dataset.name.toLowerCase();
        const level = spell.dataset.level;
        const type = spell.dataset.type;

        let showSpell = true;

        // Filtre de recherche
        if (searchTerm && !name.includes(searchTerm)) {
            showSpell = false;
        }

        // Filtre de niveau
        if (levelFilter !== 'all' && level !== levelFilter) {
            showSpell = false;
        }

        // Filtre de type
        if (typeFilter !== 'all' && type !== typeFilter) {
            showSpell = false;
        }

        spell.style.display = showSpell ? 'block' : 'none';
        if (showSpell) visibleCount++;
    });

    // Afficher message si aucun r√©sultat
    document.getElementById('no-results').style.display = visibleCount === 0 ? 'block' : 'none';

    // Mettre √† jour le compteur de sorts
    updateSpellsCount();
}

// Restaurer tous les emplacements
function restoreAllSlots() {
    if (!confirm('Prendre un repos long et restaurer tous les emplacements de sorts ?')) return;

    makeRequest('/api/restore_spell_slots', {}, function(data) {
        if (data.success) {
            // Mettre √† jour l'affichage pour tous les niveaux
            for (let level = 1; level <= 4; level++) {
                updateSpellSlots(level, data.spell_slots_current[level.toString()]);
            }
            showToast('Tous les emplacements de sorts ont √©t√© restaur√©s !', 'success');
            updateAvailableSlots();
        }
    });
}

// Basculer manuellement un slot
function toggleSlot(level, slotNumber) {
    // Cette fonction permet de cliquer sur un slot pour le remplir/vider manuellement
    // Utile pour ajuster manuellement si besoin
    const currentSlots = parseInt(document.getElementById(`spell-slots-${level}`).textContent);

    // Si on clique sur un slot vide, on restaure jusqu'√† ce slot
    // Si on clique sur un slot plein, on vide √† partir de ce slot
    const slots = document.querySelectorAll(`[data-level="${level}"][data-slot]`);
    const clickedSlot = Array.from(slots).find(s => parseInt(s.dataset.slot) === slotNumber);

    if (!clickedSlot) return;

    const isFilled = clickedSlot.style.background !== 'transparent' && clickedSlot.style.background !== '';

    // Si le slot est plein, on le vide (et tous ceux apr√®s)
    if (isFilled && slotNumber === currentSlots) {
        // Consommer un slot
        makeRequest('/api/use_spell_slot', { level: level }, function(data) {
            if (data.success) {
                updateSpellSlots(level, data.remaining);
                updateAvailableSlots();
            }
        });
    }
}

// Mettre √† jour le compteur de sorts disponibles
function updateSpellsCount() {
    const visibleSpells = document.querySelectorAll('.spell-item[style="display: block;"], .spell-item:not([style*="display: none"])').length;
    document.getElementById('total-spells-count').textContent = visibleSpells;
}

// Mettre √† jour le nombre total de slots disponibles
function updateAvailableSlots() {
    let total = 0;
    for (let i = 1; i <= 4; i++) {
        const slotElement = document.getElementById(`spell-slots-${i}`);
        if (slotElement) {
            total += parseInt(slotElement.textContent) || 0;
        }
    }
    document.getElementById('available-slots-count').textContent = total;
}

// Override de la fonction updateSpellSlots pour inclure les barres de progression
function updateSpellSlots(level, remaining) {
    console.log(`Updating spell slots: level ${level}, remaining ${remaining}`);

    const slotElement = document.getElementById(`spell-slots-${level}`);
    if (slotElement) {
        slotElement.textContent = remaining;

        // Animation
        slotElement.style.transform = 'scale(1.3)';
        slotElement.style.color = remaining > 0 ? getSlotColor(level) : 'var(--danger-red)';
        setTimeout(() => {
            slotElement.style.transform = 'scale(1)';
        }, 300);
    }

    // Mettre √† jour la barre de progression
    const progressBar = document.getElementById(`progress-${level}`);
    if (progressBar) {
        const container = progressBar.closest('.spell-slot-container-horizontal');
        const total = container ? container.querySelectorAll('.spell-slot').length : 0;
        if (total > 0) {
            const percentage = (remaining / total) * 100;
            progressBar.style.width = percentage + '%';
        }
    }

    // Mettre √† jour les slots visuels
    updateSpellSlotsVisual(level, remaining);

    // Mettre √† jour la nav si elle existe
    const navSlotElement = document.getElementById(`nav-spell-slots-${level}`);
    if (navSlotElement) {
        navSlotElement.textContent = remaining;
    }

    // Mettre √† jour le compteur total
    updateAvailableSlots();
}

function updateSpellSlotsVisual(level, remaining) {
    const slots = document.querySelectorAll(`[data-level="${level}"][data-slot]`);
    slots.forEach((slot, index) => {
        if (index < remaining) {
            slot.style.background = getSlotColor(level);
        } else {
            slot.style.background = 'transparent';
        }
    });
}

function getSlotColor(level) {
    switch (level) {
        case 1: return 'var(--primary-gold)';
        case 2: return 'var(--info-blue)';
        case 3: return 'var(--warning-orange)';
        case 4: return 'var(--danger-red)';
        default: return 'var(--text-light)';
    }
}

function castCantrip(cantripName) {
    console.log(`Casting cantrip: ${cantripName}`);

    // Trouver l'√©l√©ment spell-item si event est disponible
    if (typeof event !== 'undefined' && event && event.target) {
        const spellItem = event.target.closest('.spell-item');
        if (spellItem) {
            spellItem.style.animation = 'pulse 0.5s ease';
            setTimeout(() => spellItem.style.animation = '', 500);
        }
    }

    const displayName = cantripName.charAt(0).toUpperCase() + cantripName.slice(1);

    showDiceResult(`
        <h3>üåü ${displayName}</h3>
        <div>Objet touch√© √©met une lumi√®re vive (20 pieds) pendant 1 heure</div>
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">
            Les cantrips n'utilisent pas d'emplacements de sorts
        </div>
    `);

    // Enregistrer dans les statistiques si possible
    showToast(`${displayName} lanc√©`, 'success');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Recherche en temps r√©el
    document.getElementById('spell-search').addEventListener('input', filterSpells);
    document.getElementById('filter-level').addEventListener('change', filterSpells);
    document.getElementById('filter-type').addEventListener('change', filterSpells);

    // Initialiser les compteurs
    updateSpellsCount();
    updateAvailableSlots();

    console.log('Page Sorts am√©lior√©e charg√©e');
});
</script>
{% endblock %}
