{% extends "base.html" %}

{% block title %}Lanceur de D√©s - {{ super() }}{% endblock %}

{% block content %}
<div class="stats-grid">
    <!-- Lanceur de D√©s Principal -->
    <div class="stat-card">
        <h2 class="card-title">üé≤ Lanceur de D√©s</h2>
        <div class="card-content">
            <!-- Configuration des d√©s -->
            <div class="dice-config">
                <div class="config-row">
                    <div class="form-group">
                        <label for="dice-count">Nombre de d√©s :</label>
                        <input type="number" id="dice-count" class="form-input" value="1" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label for="dice-type">Type de d√© :</label>
                        <select id="dice-type" class="form-select">
                            <option value="4">d4</option>
                            <option value="6">d6</option>
                            <option value="8">d8</option>
                            <option value="10">d10</option>
                            <option value="12">d12</option>
                            <option value="20" selected>d20</option>
                            <option value="100">d100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dice-modifier">Modificateur :</label>
                        <input type="number" id="dice-modifier" class="form-input" value="0" min="-20" max="20">
                    </div>
                </div>

                <div class="dice-formula">
                    <span id="dice-formula-display">1d20</span>
                </div>

                <button class="btn" onclick="rollCustomDice()">üé≤ Lancer les D√©s</button>
            </div>
        </div>
    </div>

    <!-- Raccourcis Rapides -->
    <div class="stat-card">
        <h2 class="card-title">‚ö° Raccourcis Rapides</h2>
        <div class="card-content">
            <div class="quick-dice-grid">
                <button class="btn btn-small" onclick="quickRoll(1, 4)">1d4</button>
                <button class="btn btn-small" onclick="quickRoll(1, 6)">1d6</button>
                <button class="btn btn-small" onclick="quickRoll(1, 8)">1d8</button>
                <button class="btn btn-small" onclick="quickRoll(1, 10)">1d10</button>
                <button class="btn btn-small" onclick="quickRoll(1, 12)">1d12</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20)">1d20</button>

                <button class="btn btn-small" onclick="quickRoll(2, 6)">2d6</button>
                <button class="btn btn-small" onclick="quickRoll(3, 6)">3d6</button>
                <button class="btn btn-small" onclick="quickRoll(4, 6)">4d6</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20, 5)">1d20+5</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20, -2)">1d20-2</button>
                <button class="btn btn-small" onclick="quickRoll(1, 100)">1d100</button>
            </div>
        </div>
    </div>

    <!-- D√©s de D√©g√¢ts Courants -->
    <div class="stat-card">
        <h2 class="card-title">‚öîÔ∏è D√©g√¢ts d'Armes</h2>
        <div class="card-content">
            <div class="damage-dice-grid">
                <button class="btn btn-info" onclick="rollDamage('Dague', 1, 4)">Dague (1d4)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e courte', 1, 6)">√âp√©e courte (1d6)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e longue', 1, 8)">√âp√©e longue (1d8)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e √† deux mains', 2, 6)">√âp√©e 2M (2d6)</button>
                <button class="btn btn-info" onclick="rollDamage('Hache de guerre', 1, 12)">Hache guerre (1d12)</button>
                <button class="btn btn-info" onclick="rollDamage('Arc long', 1, 8)">Arc long (1d8)</button>
            </div>
        </div>
    </div>

    <!-- Info Historique -->
    <div class="stat-card">
        <h2 class="card-title">üìú Historique des Jets</h2>
        <div class="card-content">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 3rem; margin-bottom: 15px;">üìú</div>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    L'historique de tous vos jets est disponible dans le panneau d'historique global.
                </p>
                <p style="color: var(--secondary-gold); font-weight: bold; font-size: 1.2rem;">
                    Appuyez sur <kbd style="background: var(--dark-bg); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--primary-gold);">H</kbd>
                    pour ouvrir l'historique
                </p>
                <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
                    Ou cliquez sur le bouton üìú en bas √† droite de l'√©cran
                </p>
            </div>
        </div>
    </div>

    <!-- Jets avec Avantage/D√©savantage -->
    <div class="stat-card">
        <h2 class="card-title">üçÄ Avantage & D√©savantage</h2>
        <div class="card-content">
            <div class="advantage-controls">
                <button class="btn btn-success" onclick="rollWithAdvantage()">
                    üçÄ Avantage (2d20, prendre le plus haut)
                </button>
                <button class="btn btn-danger" onclick="rollWithDisadvantage()">
                    üíÄ D√©savantage (2d20, prendre le plus bas)
                </button>
                <button class="btn" onclick="rollNormal()">
                    ‚öñÔ∏è Jet Normal (1d20)
                </button>
            </div>
            <div class="advantage-note">
                <small>Les jets d'avantage/d√©savantage utilisent automatiquement le modificateur d√©fini
                    ci-dessus.</small>
            </div>
        </div>
    </div>

    <!-- Outils D&D -->
    <div class="stat-card">
        <h2 class="card-title">üéØ Outils D&D</h2>
        <div class="card-content">
            <div class="dnd-tools">
                <button class="btn btn-info" onclick="rollStats()">
                    üìä G√©n√©rer Stats (4d6, drop lowest)
                </button>
                <button class="btn btn-info" onclick="rollInitiative()">
                    ‚ö° Initiative (1d20 + Dex)
                </button>
                <button class="btn btn-info" onclick="rollPercentile()">
                    üíØ Jet de Pourcentage
                </button>
                <button class="btn btn-info" onclick="rollHitDice()">
                    ‚ù§Ô∏è D√© de Vie (1d10+3)
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styles sp√©cifiques √† la page de d√©s */
    .dice-config {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
    }

    .config-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        width: 100%;
        max-width: 600px;
    }

    .dice-formula {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-gold);
        text-align: center;
        padding: 15px;
        background: var(--dark-bg);
        border-radius: 8px;
        border: 2px solid var(--primary-gold);
        min-width: 120px;
    }

    .quick-dice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
    }

    .damage-dice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }

    .dice-history {
        max-height: 300px;
        overflow-y: auto;
        background: var(--dark-bg);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-formula {
        color: var(--secondary-gold);
        font-weight: bold;
    }

    .history-result {
        color: var(--primary-gold);
        font-size: 1.2rem;
        font-weight: bold;
    }

    .history-details {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .advantage-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .advantage-note {
        margin-top: 15px;
        padding: 10px;
        background: var(--dark-bg);
        border-radius: 6px;
        color: var(--text-muted);
    }

    .dnd-tools {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        color: var(--secondary-gold);
        font-weight: bold;
        font-size: 0.9rem;
    }

    .form-input,
    .form-select {
        padding: 8px;
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--primary-gold);
        outline: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .config-row {
            grid-template-columns: 1fr;
        }

        .quick-dice-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .damage-dice-grid {
            grid-template-columns: 1fr;
        }

        .advantage-controls {
            gap: 8px;
        }

        .dnd-tools {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Mettre √† jour l'affichage de la formule
    function updateDiceFormula() {
        const count = document.getElementById('dice-count').value;
        const type = document.getElementById('dice-type').value;
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        let formula = `${count}d${type}`;
        if (modifier > 0) formula += `+${modifier}`;
        else if (modifier < 0) formula += modifier;

        document.getElementById('dice-formula-display').textContent = formula;
    }

    // Lancer les d√©s personnalis√©s via l'API
    function rollCustomDice() {
        const count = parseInt(document.getElementById('dice-count').value);
        const type = parseInt(document.getElementById('dice-type').value);
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        rollDiceViaAPI(count, type, modifier);
    }

    // Fonction principale de lancement de d√©s via l'API
    function rollDiceViaAPI(count, sides, modifier = 0, label = '') {
        // Cr√©er la formule d'affichage
        let formula = `${count}d${sides}`;
        if (modifier > 0) formula += `+${modifier}`;
        else if (modifier < 0) formula += modifier;

        const labelToUse = label || `Jet de ${formula}`;

        // Appeler l'API
        makeRequest('/api/roll_custom_dice', {
            count: count,
            sides: sides,
            modifier: modifier,
            label: labelToUse
        }, function(data) {
            if (!data.success) {
                showDiceResult('<div class="danger">Erreur lors du lancer de d√©s</div>');
                return;
            }

            // D√©terminer le type de r√©sultat
            let resultClass = '';
            let resultIcon = 'üé≤';
            let isCritical = false;
            let isFumble = false;

            if (count === 1 && sides === 20) {
                if (data.rolls[0] === 20) {
                    resultClass = 'critical';
                    resultIcon = '‚ú®';
                    isCritical = true;
                } else if (data.rolls[0] === 1) {
                    resultClass = 'fumble';
                    resultIcon = 'üíÄ';
                    isFumble = true;
                }
            }

            // D√©tails du jet
            let details = '';
            if (count > 1) {
                details = `(${data.rolls.join(' + ')}`;
                if (modifier !== 0) details += ` ${modifier > 0 ? '+' : ''}${modifier}`;
                details += ')';
            } else if (modifier !== 0) {
                details = `(${data.rolls[0]} ${modifier > 0 ? '+' : ''}${modifier})`;
            } else {
                details = `[${data.rolls.join(', ')}]`;
            }

            // Afficher le r√©sultat
            const resultHtml = `
                <div class="dice-roll-result ${resultClass}">
                    <h3>${resultIcon} ${labelToUse}</h3>
                    <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0;">
                        ${data.total}
                    </div>
                    ${details ? `<div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">${details}</div>` : ''}
                    <div class="dice-breakdown" style="margin: 15px 0; font-size: 1rem; color: var(--secondary-gold);">
                        D√©s lanc√©s : [${data.rolls.join(', ')}]
                    </div>
                    ${resultClass === 'critical' ? '<div style="color: var(--success-green); font-weight: bold;">üéâ Critique ! üéâ</div>' : ''}
                    ${resultClass === 'fumble' ? '<div style="color: var(--danger-red); font-weight: bold;">üíÄ √âchec critique üíÄ</div>' : ''}
                </div>
            `;

            // Cr√©er les donn√©es pour l'historique global
            const rollData = {
                roll_type: labelToUse,
                formula: data.formula,
                result: data.total,
                details: details,
                critical: isCritical,
                fumble: isFumble
            };

            showDiceResult(resultHtml, rollData);
        });
    }

    // Jets rapides
    function quickRoll(count, sides, modifier = 0) {
        rollDiceViaAPI(count, sides, modifier);
    }

    // Jets de d√©g√¢ts d'armes
    function rollDamage(weaponName, count, sides) {
        rollDiceViaAPI(count, sides, 0, `D√©g√¢ts ${weaponName}`);
    }

    // Jet avec avantage
    function rollWithAdvantage() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        // Lancer 2d20 via l'API
        rollDiceViaAPI(2, 20, 0, 'Avantage (brut)');

        // Note: L'affichage sera g√©r√© par l'API, mais on pourrait am√©liorer
        // la logique pour vraiment prendre le plus haut. Pour l'instant,
        // on lance juste 2d20 pour visualiser.
    }

    // Jet avec d√©savantage
    function rollWithDisadvantage() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        // Lancer 2d20 via l'API
        rollDiceViaAPI(2, 20, 0, 'D√©savantage (brut)');

        // Note: M√™me remarque que pour l'avantage
    }

    // Jet normal d20
    function rollNormal() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);
        rollDiceViaAPI(1, 20, modifier, 'Jet Normal');
    }

    // Outils D&D
    function rollStats() {
        // On lance 6 fois 4d6 (sans drop lowest pour simplifier avec l'API)
        // Note: L'impl√©mentation compl√®te n√©cessiterait une API sp√©cifique
        rollDiceViaAPI(4, 6, 0, 'Stats - Force');
        setTimeout(() => rollDiceViaAPI(4, 6, 0, 'Stats - Dext√©rit√©'), 200);
        setTimeout(() => rollDiceViaAPI(4, 6, 0, 'Stats - Constitution'), 400);
        setTimeout(() => rollDiceViaAPI(4, 6, 0, 'Stats - Intelligence'), 600);
        setTimeout(() => rollDiceViaAPI(4, 6, 0, 'Stats - Sagesse'), 800);
        setTimeout(() => rollDiceViaAPI(4, 6, 0, 'Stats - Charisme'), 1000);
    }

    function rollInitiative() {
        // Dext√©rit√© de Thalric: +0
        rollDiceViaAPI(1, 20, 0, 'Initiative');
    }

    function rollPercentile() {
        rollDiceViaAPI(1, 100, 0, 'Pourcentage (d100)');
    }

    function rollHitDice() {
        // D√© de vie de Paladin (d10) + Constitution (+2)
        rollDiceViaAPI(1, 10, 2, 'D√© de Vie');
    }

    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function () {
        // √âcouter les changements dans la configuration
        document.getElementById('dice-count').addEventListener('input', updateDiceFormula);
        document.getElementById('dice-type').addEventListener('change', updateDiceFormula);
        document.getElementById('dice-modifier').addEventListener('input', updateDiceFormula);

        // Initialiser l'affichage
        updateDiceFormula();

        console.log('Page Lanceur de D√©s initialis√©e - Int√©gr√©e avec le syst√®me global');
    });
</script>
{% endblock %}