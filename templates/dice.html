{% extends "base.html" %}

{% block title %}Lanceur de D√©s - {{ super() }}{% endblock %}

{% block content %}
<div class="stats-grid">
    <!-- Lanceur de D√©s Principal -->
    <div class="stat-card">
        <h2 class="card-title">üé≤ Lanceur de D√©s</h2>
        <div class="card-content">
            <!-- Configuration des d√©s -->
            <div class="dice-config">
                <div class="config-row">
                    <div class="form-group">
                        <label for="dice-count">Nombre de d√©s :</label>
                        <input type="number" id="dice-count" class="form-input" value="1" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label for="dice-type">Type de d√© :</label>
                        <select id="dice-type" class="form-select">
                            <option value="4">d4</option>
                            <option value="6">d6</option>
                            <option value="8">d8</option>
                            <option value="10">d10</option>
                            <option value="12">d12</option>
                            <option value="20" selected>d20</option>
                            <option value="100">d100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dice-modifier">Modificateur :</label>
                        <input type="number" id="dice-modifier" class="form-input" value="0" min="-20" max="20">
                    </div>
                </div>

                <div class="dice-formula">
                    <span id="dice-formula-display">1d20</span>
                </div>

                <button class="btn" onclick="rollCustomDice()">üé≤ Lancer les D√©s</button>
            </div>
        </div>
    </div>

    <!-- Raccourcis Rapides -->
    <div class="stat-card">
        <h2 class="card-title">‚ö° Raccourcis Rapides</h2>
        <div class="card-content">
            <div class="quick-dice-grid">
                <button class="btn btn-small" onclick="quickRoll(1, 4)">1d4</button>
                <button class="btn btn-small" onclick="quickRoll(1, 6)">1d6</button>
                <button class="btn btn-small" onclick="quickRoll(1, 8)">1d8</button>
                <button class="btn btn-small" onclick="quickRoll(1, 10)">1d10</button>
                <button class="btn btn-small" onclick="quickRoll(1, 12)">1d12</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20)">1d20</button>

                <button class="btn btn-small" onclick="quickRoll(2, 6)">2d6</button>
                <button class="btn btn-small" onclick="quickRoll(3, 6)">3d6</button>
                <button class="btn btn-small" onclick="quickRoll(4, 6)">4d6</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20, 5)">1d20+5</button>
                <button class="btn btn-small" onclick="quickRoll(1, 20, -2)">1d20-2</button>
                <button class="btn btn-small" onclick="quickRoll(1, 100)">1d100</button>
            </div>
        </div>
    </div>

    <!-- D√©s de D√©g√¢ts Courants -->
    <div class="stat-card">
        <h2 class="card-title">‚öîÔ∏è D√©g√¢ts d'Armes</h2>
        <div class="card-content">
            <div class="damage-dice-grid">
                <button class="btn btn-info" onclick="rollDamage('Dague', 1, 4)">Dague (1d4)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e courte', 1, 6)">√âp√©e courte (1d6)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e longue', 1, 8)">√âp√©e longue (1d8)</button>
                <button class="btn btn-info" onclick="rollDamage('√âp√©e √† deux mains', 2, 6)">√âp√©e 2M (2d6)</button>
                <button class="btn btn-info" onclick="rollDamage('Hache de guerre', 1, 12)">Hache guerre (1d12)</button>
                <button class="btn btn-info" onclick="rollDamage('Arc long', 1, 8)">Arc long (1d8)</button>
            </div>
        </div>
    </div>

    <!-- Historique des Jets -->
    <div class="stat-card">
        <h2 class="card-title">üìú Historique des Jets</h2>
        <div class="card-content">
            <div class="dice-history" id="dice-history">
                <div class="history-item">
                    <span class="history-formula">1d20+3</span>
                    <span class="history-result">15</span>
                    <span class="history-details">(12 + 3)</span>
                </div>
            </div>
            <button class="btn btn-small btn-danger" onclick="clearHistory()">Effacer l'historique</button>
        </div>
    </div>

    <!-- Jets avec Avantage/D√©savantage -->
    <div class="stat-card">
        <h2 class="card-title">üçÄ Avantage & D√©savantage</h2>
        <div class="card-content">
            <div class="advantage-controls">
                <button class="btn btn-success" onclick="rollWithAdvantage()">
                    üçÄ Avantage (2d20, prendre le plus haut)
                </button>
                <button class="btn btn-danger" onclick="rollWithDisadvantage()">
                    üíÄ D√©savantage (2d20, prendre le plus bas)
                </button>
                <button class="btn" onclick="rollNormal()">
                    ‚öñÔ∏è Jet Normal (1d20)
                </button>
            </div>
            <div class="advantage-note">
                <small>Les jets d'avantage/d√©savantage utilisent automatiquement le modificateur d√©fini
                    ci-dessus.</small>
            </div>
        </div>
    </div>

    <!-- Outils D&D -->
    <div class="stat-card">
        <h2 class="card-title">üéØ Outils D&D</h2>
        <div class="card-content">
            <div class="dnd-tools">
                <button class="btn btn-info" onclick="rollStats()">
                    üìä G√©n√©rer Stats (4d6, drop lowest)
                </button>
                <button class="btn btn-info" onclick="rollInitiative()">
                    ‚ö° Initiative (1d20 + Dex)
                </button>
                <button class="btn btn-info" onclick="rollPercentile()">
                    üíØ Jet de Pourcentage
                </button>
                <button class="btn btn-info" onclick="rollHitDice()">
                    ‚ù§Ô∏è D√© de Vie (1d10+3)
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Styles sp√©cifiques √† la page de d√©s */
    .dice-config {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
    }

    .config-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        width: 100%;
        max-width: 600px;
    }

    .dice-formula {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-gold);
        text-align: center;
        padding: 15px;
        background: var(--dark-bg);
        border-radius: 8px;
        border: 2px solid var(--primary-gold);
        min-width: 120px;
    }

    .quick-dice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
    }

    .damage-dice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }

    .dice-history {
        max-height: 300px;
        overflow-y: auto;
        background: var(--dark-bg);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-formula {
        color: var(--secondary-gold);
        font-weight: bold;
    }

    .history-result {
        color: var(--primary-gold);
        font-size: 1.2rem;
        font-weight: bold;
    }

    .history-details {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .advantage-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .advantage-note {
        margin-top: 15px;
        padding: 10px;
        background: var(--dark-bg);
        border-radius: 6px;
        color: var(--text-muted);
    }

    .dnd-tools {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .form-group label {
        color: var(--secondary-gold);
        font-weight: bold;
        font-size: 0.9rem;
    }

    .form-input,
    .form-select {
        padding: 8px;
        background: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .form-input:focus,
    .form-select:focus {
        border-color: var(--primary-gold);
        outline: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .config-row {
            grid-template-columns: 1fr;
        }

        .quick-dice-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .damage-dice-grid {
            grid-template-columns: 1fr;
        }

        .advantage-controls {
            gap: 8px;
        }

        .dnd-tools {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Variables globales pour l'historique
    let diceHistory = JSON.parse(localStorage.getItem('dice-history') || '[]');

    // Mettre √† jour l'affichage de la formule
    function updateDiceFormula() {
        const count = document.getElementById('dice-count').value;
        const type = document.getElementById('dice-type').value;
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        let formula = `${count}d${type}`;
        if (modifier > 0) formula += `+${modifier}`;
        else if (modifier < 0) formula += modifier;

        document.getElementById('dice-formula-display').textContent = formula;
    }

    // Lancer les d√©s personnalis√©s
    function rollCustomDice() {
        const count = parseInt(document.getElementById('dice-count').value);
        const type = parseInt(document.getElementById('dice-type').value);
        const modifier = parseInt(document.getElementById('dice-modifier').value);

        rollDice(count, type, modifier);
    }

    // Fonction principale de lancement de d√©s
    function rollDice(count, sides, modifier = 0, label = '') {
        const rolls = [];
        let total = 0;

        // Lancer chaque d√©
        for (let i = 0; i < count; i++) {
            const roll = Math.floor(Math.random() * sides) + 1;
            rolls.push(roll);
            total += roll;
        }

        const finalTotal = total + modifier;

        // Cr√©er la formule d'affichage
        let formula = `${count}d${sides}`;
        if (modifier > 0) formula += `+${modifier}`;
        else if (modifier < 0) formula += modifier;

        // D√©tails du jet
        let details = '';
        if (count > 1) {
            details = `(${rolls.join(' + ')}`;
            if (modifier !== 0) details += ` ${modifier > 0 ? '+' : ''}${modifier}`;
            details += ')';
        } else if (modifier !== 0) {
            details = `(${rolls[0]} ${modifier > 0 ? '+' : ''}${modifier})`;
        }

        // D√©terminer le type de r√©sultat
        let resultClass = '';
        let resultIcon = 'üé≤';

        if (count === 1 && sides === 20) {
            if (rolls[0] === 20) {
                resultClass = 'critical';
                resultIcon = '‚ú®';
            } else if (rolls[0] === 1) {
                resultClass = 'fumble';
                resultIcon = 'üíÄ';
            }
        }

        // Afficher le r√©sultat
        const resultTitle = label || `Jet de ${formula}`;
        const resultHtml = `
        <div class="dice-roll-result ${resultClass}">
            <h3>${resultIcon} ${resultTitle}</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0;">
                ${finalTotal}
            </div>
            ${details ? `<div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">${details}</div>` : ''}
            <div class="dice-breakdown" style="margin: 15px 0; font-size: 1rem; color: var(--secondary-gold);">
                D√©s lanc√©s : [${rolls.join(', ')}]
            </div>
            ${resultClass === 'critical' ? '<div style="color: var(--success-green); font-weight: bold;">üéâ Critique ! üéâ</div>' : ''}
            ${resultClass === 'fumble' ? '<div style="color: var(--danger-red); font-weight: bold;">üíÄ √âchec critique üíÄ</div>' : ''}
        </div>
    `;

        showDiceResult(resultHtml);

        // Ajouter √† l'historique
        addToHistory(formula, finalTotal, details, label);

        return finalTotal;
    }

    // Jets rapides
    function quickRoll(count, sides, modifier = 0) {
        rollDice(count, sides, modifier);
    }

    // Jets de d√©g√¢ts d'armes
    function rollDamage(weaponName, count, sides) {
        rollDice(count, sides, 0, `D√©g√¢ts ${weaponName}`);
    }

    // Jet avec avantage
    function rollWithAdvantage() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);
        const roll1 = Math.floor(Math.random() * 20) + 1;
        const roll2 = Math.floor(Math.random() * 20) + 1;
        const highest = Math.max(roll1, roll2);
        const total = highest + modifier;

        let formula = `Avantage 2d20`;
        if (modifier !== 0) formula += ` ${modifier > 0 ? '+' : ''}${modifier}`;

        const resultHtml = `
        <div class="dice-roll-result advantage">
            <h3>üçÄ Jet avec Avantage</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0; color: var(--success-green);">
                ${total}
            </div>
            <div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">
                (${roll1}, ${roll2} ‚Üí ${highest}${modifier !== 0 ? ` ${modifier > 0 ? '+' : ''}${modifier}` : ''})
            </div>
            <div class="dice-breakdown" style="margin: 15px 0; font-size: 1rem; color: var(--success-green);">
                D√©s lanc√©s : [${roll1}, ${roll2}] ‚Üí Prendre le plus haut : ${highest}
            </div>
        </div>
    `;

        showDiceResult(resultHtml);
        addToHistory(formula, total, `(${roll1}, ${roll2} ‚Üí ${highest})`, 'Avantage');
    }

    // Jet avec d√©savantage
    function rollWithDisadvantage() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);
        const roll1 = Math.floor(Math.random() * 20) + 1;
        const roll2 = Math.floor(Math.random() * 20) + 1;
        const lowest = Math.min(roll1, roll2);
        const total = lowest + modifier;

        let formula = `D√©savantage 2d20`;
        if (modifier !== 0) formula += ` ${modifier > 0 ? '+' : ''}${modifier}`;

        const resultHtml = `
        <div class="dice-roll-result disadvantage">
            <h3>üíÄ Jet avec D√©savantage</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0; color: var(--danger-red);">
                ${total}
            </div>
            <div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">
                (${roll1}, ${roll2} ‚Üí ${lowest}${modifier !== 0 ? ` ${modifier > 0 ? '+' : ''}${modifier}` : ''})
            </div>
            <div class="dice-breakdown" style="margin: 15px 0; font-size: 1rem; color: var(--danger-red);">
                D√©s lanc√©s : [${roll1}, ${roll2}] ‚Üí Prendre le plus bas : ${lowest}
            </div>
        </div>
    `;

        showDiceResult(resultHtml);
        addToHistory(formula, total, `(${roll1}, ${roll2} ‚Üí ${lowest})`, 'D√©savantage');
    }

    // Jet normal d20
    function rollNormal() {
        const modifier = parseInt(document.getElementById('dice-modifier').value);
        rollDice(1, 20, modifier, 'Jet Normal');
    }

    // Outils D&D
    function rollStats() {
        const stats = [];
        let resultHtml = '<h3>üìä G√©n√©ration de Statistiques</h3><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">';

        const abilities = ['Force', 'Dext√©rit√©', 'Constitution', 'Intelligence', 'Sagesse', 'Charisme'];

        for (let i = 0; i < 6; i++) {
            // Lancer 4d6, garder les 3 plus hauts
            const rolls = Array.from({ length: 4 }, () => Math.floor(Math.random() * 6) + 1);
            rolls.sort((a, b) => b - a);
            const stat = rolls[0] + rolls[1] + rolls[2];
            stats.push(stat);

            resultHtml += `
            <div style="background: var(--dark-bg); padding: 12px; border-radius: 6px; text-align: center;">
                <div style="color: var(--secondary-gold); font-weight: bold;">${abilities[i]}</div>
                <div style="font-size: 1.5rem; color: var(--primary-gold); margin: 5px 0;">${stat}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">[${rolls.join(', ')}]</div>
            </div>
        `;
        }

        resultHtml += '</div><div style="text-align: center; color: var(--text-muted);">Total des modificateurs : ' +
            stats.map(s => Math.floor((s - 10) / 2)).reduce((a, b) => a + b, 0) + '</div>';

        showDiceResult(resultHtml);
        addToHistory('6x(4d6 drop lowest)', `Stats g√©n√©r√©es`, `Moyennes: ${(stats.reduce((a, b) => a + b) / 6).toFixed(1)}`, 'G√©n√©ration Stats');
    }

    function rollInitiative() {
        // Utiliser la Dext√©rit√© de Thalric (+3)
        const dexMod = 3;
        const roll = Math.floor(Math.random() * 20) + 1;
        const total = roll + dexMod;

        const resultHtml = `
        <div class="dice-roll-result">
            <h3>‚ö° Initiative</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0;">
                ${total}
            </div>
            <div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">
                (${roll} + ${dexMod} Dex)
            </div>
        </div>
    `;

        showDiceResult(resultHtml);
        addToHistory('1d20+3', total, `(${roll} + 3)`, 'Initiative');
    }

    function rollPercentile() {
        const roll = Math.floor(Math.random() * 100) + 1;

        const resultHtml = `
        <div class="dice-roll-result">
            <h3>üíØ Jet de Pourcentage</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0;">
                ${roll}%
            </div>
        </div>
    `;

        showDiceResult(resultHtml);
        addToHistory('d100', roll, `${roll}%`, 'Pourcentage');
    }

    function rollHitDice() {
        // D√© de vie de Paladin (d10) + Constitution (+3)
        const roll = Math.floor(Math.random() * 10) + 1;
        const total = roll + 3;

        const resultHtml = `
        <div class="dice-roll-result">
            <h3>‚ù§Ô∏è D√© de Vie</h3>
            <div class="dice-roll" style="font-size: 2.5rem; margin: 15px 0; color: var(--success-green);">
                ${total}
            </div>
            <div class="dice-details" style="font-size: 1.1rem; color: var(--text-muted);">
                (${roll} + 3 Con) PV r√©cup√©r√©s
            </div>
        </div>
    `;

        showDiceResult(resultHtml);
        addToHistory('1d10+3', total, `(${roll} + 3)`, 'D√© de Vie');
    }

    // Gestion de l'historique
    function addToHistory(formula, result, details, label) {
        const historyItem = {
            formula: label || formula,
            result: result,
            details: details || '',
            timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
        };

        diceHistory.unshift(historyItem);

        // Garder seulement les 20 derniers jets
        if (diceHistory.length > 20) {
            diceHistory = diceHistory.slice(0, 20);
        }

        // Sauvegarder dans localStorage
        localStorage.setItem('dice-history', JSON.stringify(diceHistory));

        // Mettre √† jour l'affichage
        updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
        const historyContainer = document.getElementById('dice-history');

        if (diceHistory.length === 0) {
            historyContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Aucun jet dans l\'historique</div>';
            return;
        }

        historyContainer.innerHTML = diceHistory.map(item => `
        <div class="history-item">
            <div>
                <span class="history-formula">${item.formula}</span>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${item.timestamp}</div>
            </div>
            <span class="history-result">${item.result}</span>
            <span class="history-details">${item.details}</span>
        </div>
    `).join('');
    }

    function clearHistory() {
        if (confirm('Effacer tout l\'historique des jets ?')) {
            diceHistory = [];
            localStorage.removeItem('dice-history');
            updateHistoryDisplay();
        }
    }

    // Initialisation de la page
    document.addEventListener('DOMContentLoaded', function () {
        // √âcouter les changements dans la configuration
        document.getElementById('dice-count').addEventListener('input', updateDiceFormula);
        document.getElementById('dice-type').addEventListener('change', updateDiceFormula);
        document.getElementById('dice-modifier').addEventListener('input', updateDiceFormula);

        // Initialiser l'affichage
        updateDiceFormula();
        updateHistoryDisplay();

        console.log('Page Lanceur de D√©s initialis√©e');
    });
</script>
{% endblock %}