{% extends "base.html" %}

{% block title %}Statistiques - {{ super() }}{% endblock %}

{% block content %}
<h1 style="text-align: center; color: var(--primary-gold); margin-bottom: 30px;">üìä Statistiques des Jets de D√©s</h1>

<div class="stats-grid">
    <!-- R√âSUM√â G√âN√âRAL -->
    <div class="stat-card">
        <h2 class="card-title">üìà R√©sum√© G√©n√©ral</h2>
        <div class="card-content" id="summary-content">
            <p style="text-align: center; color: var(--text-muted);">Chargement...</p>
        </div>
    </div>

    <!-- DISTRIBUTION DES JETS DE D20 -->
    <div class="stat-card" style="grid-column: span 2;">
        <h2 class="card-title">üé≤ Distribution des Jets de d20</h2>
        <div class="card-content">
            <canvas id="distribution-chart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- STATISTIQUES PAR TYPE -->
    <div class="stat-card" style="grid-column: span 2;">
        <h2 class="card-title">üìã Statistiques par Type de Jet</h2>
        <div class="card-content">
            <div id="stats-by-type" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--text-muted);">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- ACTIVIT√â SUR 7 JOURS -->
    <div class="stat-card" style="grid-column: span 2;">
        <h2 class="card-title">üìÖ Activit√© des 7 Derniers Jours</h2>
        <div class="card-content">
            <canvas id="activity-chart" style="max-height: 250px;"></canvas>
        </div>
    </div>

    <!-- JETS R√âCENTS -->
    <div class="stat-card" style="grid-column: span 2;">
        <h2 class="card-title">üïê Jets R√©cents (20 derniers)</h2>
        <div class="card-content">
            <div id="recent-rolls" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--text-muted);">Chargement...</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let distributionChart = null;
let activityChart = null;

// ============================================================================
// CHARGEMENT DES DONN√âES
// ============================================================================

async function loadAllStats() {
    await Promise.all([
        loadSummary(),
        loadDistribution(),
        loadStatsByType(),
        loadActivity(),
        loadRecentRolls()
    ]);
}

async function loadSummary() {
    try {
        const res = await fetch('/api/stats/summary');
        const data = await res.json();

        const container = document.getElementById('summary-content');

        if (data.total_rolls === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucune statistique disponible.<br>Lancez des d√©s pour commencer √† collecter des donn√©es !</p>';
            return;
        }

        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; background: var(--dark-bg); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary-gold);">${data.total_rolls}</div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Jets Totaux</div>
                </div>
                <div style="text-align: center; background: var(--dark-bg); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--success-green);">${data.criticals}</div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Critiques (${data.critical_rate}%)</div>
                </div>
                <div style="text-align: center; background: var(--dark-bg); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--danger-red);">${data.fumbles}</div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">√âchecs (${data.fumble_rate}%)</div>
                </div>
                <div style="text-align: center; background: var(--dark-bg); padding: 15px; border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--info-blue);">${data.average_result.toFixed(1)}</div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Moyenne</div>
                </div>
            </div>
        `;
    } catch (err) {
        console.error(err);
    }
}

async function loadDistribution() {
    try {
        const res = await fetch('/api/stats/distribution');
        const distribution = await res.json();

        const labels = Object.keys(distribution).map(n => `${n}`);
        const values = Object.values(distribution);

        const ctx = document.getElementById('distribution-chart').getContext('2d');

        if (distributionChart) {
            distributionChart.destroy();
        }

        distributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nombre de jets',
                    data: values,
                    backgroundColor: values.map((v, i) => {
                        const num = parseInt(labels[i]);
                        if (num === 20) return 'rgba(76, 175, 80, 0.8)';  // Vert pour 20
                        if (num === 1) return 'rgba(244, 67, 54, 0.8)';   // Rouge pour 1
                        return 'rgba(212, 175, 55, 0.8)';                  // Or pour les autres
                    }),
                    borderColor: values.map((v, i) => {
                        const num = parseInt(labels[i]);
                        if (num === 20) return 'rgba(76, 175, 80, 1)';
                        if (num === 1) return 'rgba(244, 67, 54, 1)';
                        return 'rgba(212, 175, 55, 1)';
                    }),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Fr√©quence de chaque r√©sultat (1-20)',
                        color: '#d4af37',
                        font: {size: 14}
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {color: '#b0b0b0'},
                        grid: {color: 'rgba(255, 255, 255, 0.1)'}
                    },
                    x: {
                        ticks: {color: '#b0b0b0'},
                        grid: {color: 'rgba(255, 255, 255, 0.1)'}
                    }
                }
            }
        });
    } catch (err) {
        console.error(err);
    }
}

async function loadStatsByType() {
    try {
        const res = await fetch('/api/stats/by_type');
        const stats = await res.json();

        const container = document.getElementById('stats-by-type');

        if (Object.keys(stats).length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucune donn√©e</p>';
            return;
        }

        // Trier par nombre de jets (descendant)
        const sortedStats = Object.entries(stats).sort((a, b) => b[1].count - a[1].count);

        container.innerHTML = sortedStats.map(([type, data]) => `
            <div style="background: var(--dark-bg); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--primary-gold);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-weight: bold; color: var(--primary-gold); font-size: 1.1rem;">${type}</div>
                    <div style="background: var(--medium-bg); padding: 5px 12px; border-radius: 15px; font-weight: bold;">${data.count} jets</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; font-size: 0.9rem;">
                    <div>
                        <span style="color: var(--text-muted);">Moyenne: </span>
                        <span style="color: var(--info-blue); font-weight: bold;">${data.average}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-muted);">Min: </span>
                        <span style="color: var(--text-light);">${data.min}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-muted);">Max: </span>
                        <span style="color: var(--text-light);">${data.max}</span>
                    </div>
                    <div>
                        <span style="color: var(--text-muted);">Critiques: </span>
                        <span style="color: var(--success-green); font-weight: bold;">${data.criticals} (${data.critical_rate}%)</span>
                    </div>
                    <div>
                        <span style="color: var(--text-muted);">√âchecs: </span>
                        <span style="color: var(--danger-red); font-weight: bold;">${data.fumbles} (${data.fumble_rate}%)</span>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error(err);
    }
}

async function loadActivity() {
    try {
        const res = await fetch('/api/stats/by_period?days=7');
        const data = await res.json();

        // Cr√©er un array de 7 derniers jours
        const days = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const key = d.toISOString().split('T')[0];
            days.push({
                date: key,
                label: d.toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'}),
                count: data[key] || 0
            });
        }

        const ctx = document.getElementById('activity-chart').getContext('2d');

        if (activityChart) {
            activityChart.destroy();
        }

        activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: days.map(d => d.label),
                datasets: [{
                    label: 'Jets par jour',
                    data: days.map(d => d.count),
                    borderColor: 'rgba(212, 175, 55, 1)',
                    backgroundColor: 'rgba(212, 175, 55, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: {color: '#d4af37'}
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {color: '#b0b0b0', stepSize: 1},
                        grid: {color: 'rgba(255, 255, 255, 0.1)'}
                    },
                    x: {
                        ticks: {color: '#b0b0b0'},
                        grid: {color: 'rgba(255, 255, 255, 0.1)'}
                    }
                }
            }
        });
    } catch (err) {
        console.error(err);
    }
}

async function loadRecentRolls() {
    try {
        const res = await fetch('/api/stats/recent?limit=20');
        const data = await res.json();

        const container = document.getElementById('recent-rolls');

        if (!data.rolls || data.rolls.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Aucun jet r√©cent</p>';
            return;
        }

        container.innerHTML = data.rolls.map(roll => {
            let borderColor = 'var(--primary-gold)';
            if (roll.critical) borderColor = 'var(--success-green)';
            if (roll.fumble) borderColor = 'var(--danger-red)';

            return `
                <div style="background: var(--dark-bg); padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${borderColor}; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; color: var(--primary-gold);">${roll.roll_type}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">
                            ${roll.formula} = ${roll.result}
                            ${roll.critical ? ' ‚Ä¢ ‚ú® Critique' : ''}
                            ${roll.fumble ? ' ‚Ä¢ üíÄ √âchec' : ''}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 0.8rem; color: var(--text-muted);">
                        ${new Date(roll.timestamp).toLocaleString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error(err);
    }
}

// ============================================================================
// INITIALISATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
    loadAllStats();

    // Actualiser toutes les 30 secondes
    setInterval(loadAllStats, 30000);
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

@media (min-width: 1200px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}
