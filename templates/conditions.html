{% extends "base.html" %}

{% block title %}Conditions & √âtats - {{ character.character_info.name }}{% endblock %}

{% block content %}
<h1 style="text-align: center; color: var(--primary-gold); margin-bottom: 20px;">ü©π Conditions & √âtats</h1>

<!-- Actions rapides -->
<div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
    <button onclick="decrementRounds()" class="btn btn-warning" style="font-size: 1.1rem;">
        ‚è≠Ô∏è Fin du Round
    </button>
    <button onclick="clearAllConditions()" class="btn btn-danger" style="font-size: 1.1rem;">
        ‚úñÔ∏è Retirer Tout
    </button>
</div>

<!-- Conditions Actives -->
<div class="stat-card" style="margin-bottom: 30px;">
    <h2 class="card-title">‚ö†Ô∏è Conditions Actives</h2>
    <div class="card-content">
        <div id="active-conditions" style="min-height: 80px;">
            <p style="text-align: center; color: var(--text-muted);">Chargement...</p>
        </div>
    </div>
</div>

<!-- Catalogue des Conditions -->
<div class="stat-card">
    <h2 class="card-title">üìö Toutes les Conditions D&D 5e</h2>
    <div class="card-content">
        <div style="margin-bottom: 20px;">
            <input type="text" id="condition-search" placeholder="üîç Rechercher une condition..."
                style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-color); border-radius: 8px; color: var(--text-light); font-size: 1rem;">
        </div>
        <div id="conditions-catalog" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
            <p style="text-align: center; color: var(--text-muted);">Chargement...</p>
        </div>
    </div>
</div>

<!-- Dialog pour ajouter condition -->
<div id="add-condition-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: var(--medium-bg); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 id="dialog-title" style="color: var(--primary-gold); margin-bottom: 20px;">Ajouter une Condition</h2>

        <div style="margin-bottom: 20px;">
            <label style="color: var(--secondary-gold); font-weight: bold; display: block; margin-bottom: 8px;">Dur√©e :</label>
            <select id="duration-type" style="width: 100%; padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-light); font-size: 1rem; margin-bottom: 10px;">
                <option value="permanent">Permanent / Jusqu'√† dissipation</option>
                <option value="rounds">Tours de combat</option>
                <option value="minutes">Minutes</option>
                <option value="hours">Heures</option>
                <option value="long_rest">Jusqu'au repos long</option>
                <option value="instant">Instantan√©</option>
            </select>
            <input type="number" id="duration-value" placeholder="Nombre de tours/minutes/heures" min="1" style="width: 100%; padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-light); font-size: 1rem; display: none;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="color: var(--secondary-gold); font-weight: bold; display: block; margin-bottom: 8px;">Source (optionnel) :</label>
            <input type="text" id="condition-source" placeholder="Ex: Hold Person, Rayon empoisonn√©..." style="width: 100%; padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-light); font-size: 1rem;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="color: var(--secondary-gold); font-weight: bold; display: block; margin-bottom: 8px;">Notes (optionnel) :</label>
            <textarea id="condition-notes" placeholder="Notes suppl√©mentaires..." rows="3" style="width: 100%; padding: 10px; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-light); font-size: 1rem; resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn" onclick="hideAddConditionDialog()">Annuler</button>
            <button class="btn btn-success" onclick="confirmAddCondition()">‚úÖ Ajouter</button>
        </div>
    </div>
</div>

<style>
.condition-card {
    background: var(--dark-bg);
    border-radius: 10px;
    padding: 15px;
    border: 2px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.condition-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

.condition-card.active {
    border-width: 3px;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
}

.condition-icon {
    font-size: 2.5rem;
    display: block;
    text-align: center;
    margin-bottom: 10px;
}

.condition-name {
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 8px;
}

.condition-effects {
    font-size: 0.85rem;
    color: var(--text-muted);
    list-style: none;
    padding: 0;
}

.condition-effects li {
    margin-bottom: 5px;
    padding-left: 15px;
    position: relative;
}

.condition-effects li:before {
    content: '‚ñ∏';
    position: absolute;
    left: 0;
    color: var(--primary-gold);
}

.condition-timer {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--danger-red);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
}
</style>

<script>
let selectedConditionId = null;
let allDefinitions = {};

// ============================================================================
// CHARGEMENT
// ============================================================================

async function loadConditions() {
    await Promise.all([
        loadActiveConditions(),
        loadConditionsDefinitions()
    ]);
}

async function loadActiveConditions() {
    try {
        const res = await fetch('/api/conditions/list');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const container = document.getElementById('active-conditions');

        if (!data.conditions || data.conditions.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--success-green); padding: 20px;">‚úÖ Aucune condition active</p>';
            return;
        }

        container.innerHTML = data.conditions.map(cond => {
            let timerHTML = '';
            if (cond.duration_type === 'rounds' && cond.duration_value) {
                timerHTML = `<div class="condition-timer">${cond.duration_value} round(s)</div>`;
            } else if (cond.expires_at) {
                const remaining = Math.ceil((new Date(cond.expires_at) - new Date()) / 60000);
                timerHTML = `<div class="condition-timer">${remaining} min</div>`;
            }

            const effectsHTML = cond.effects.slice(0, 3).map(e => `<li>${e}</li>`).join('');

            return `
                <div class="condition-card active" style="border-color: ${cond.color};" onclick="removeConditionPrompt('${cond.id}', '${cond.name}')">
                    ${timerHTML}
                    <div class="condition-icon">${cond.icon}</div>
                    <div class="condition-name" style="color: ${cond.color};">${cond.name}</div>
                    <ul class="condition-effects">${effectsHTML}</ul>
                    ${cond.source ? `<div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">Source: ${cond.source}</div>` : ''}
                    ${cond.notes ? `<div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; font-style: italic; margin-top: 5px;">${cond.notes}</div>` : ''}
                    <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--danger-red); font-weight: bold;">Cliquer pour retirer</div>
                </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Erreur loadActiveConditions:', err);
        document.getElementById('active-conditions').innerHTML = '<p style="color: var(--danger-red);">‚ùå Erreur de chargement</p>';
    }
}

async function loadConditionsDefinitions() {
    try {
        const res = await fetch('/api/conditions/definitions');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        allDefinitions = data.definitions;

        const container = document.getElementById('conditions-catalog');

        container.innerHTML = Object.entries(allDefinitions).map(([id, def]) => {
            const effectsHTML = def.effects.slice(0, 3).map(e => `<li>${e}</li>`).join('');
            const moreEffects = def.effects.length > 3 ? `<li style="color: var(--primary-gold);">+ ${def.effects.length - 3} autre(s) effet(s)</li>` : '';

            return `
                <div class="condition-card" style="border-color: ${def.color};" onclick="showAddConditionDialog('${id}', '${def.name}', '${def.icon}')">
                    <div class="condition-icon">${def.icon}</div>
                    <div class="condition-name" style="color: ${def.color};">${def.name}</div>
                    <ul class="condition-effects">${effectsHTML}${moreEffects}</ul>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--success-green); font-weight: bold;">Cliquer pour ajouter</div>
                </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Erreur loadConditionsDefinitions:', err);
        document.getElementById('conditions-catalog').innerHTML = '<p style="color: var(--danger-red);">‚ùå Erreur de chargement</p>';
    }
}

// ============================================================================
// GESTION DES CONDITIONS
// ============================================================================

function showAddConditionDialog(conditionId, conditionName, icon) {
    selectedConditionId = conditionId;
    document.getElementById('dialog-title').innerHTML = `${icon} Ajouter : ${conditionName}`;
    document.getElementById('duration-type').value = 'permanent';
    document.getElementById('duration-value').value = '';
    document.getElementById('duration-value').style.display = 'none';
    document.getElementById('condition-source').value = '';
    document.getElementById('condition-notes').value = '';
    document.getElementById('add-condition-dialog').style.display = 'flex';
}

function hideAddConditionDialog() {
    document.getElementById('add-condition-dialog').style.display = 'none';
    selectedConditionId = null;
}

// Afficher/cacher le champ de valeur selon le type de dur√©e
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('duration-type').addEventListener('change', (e) => {
        const valueField = document.getElementById('duration-value');
        if (['rounds', 'minutes', 'hours'].includes(e.target.value)) {
            valueField.style.display = 'block';
        } else {
            valueField.style.display = 'none';
        }
    });
});

async function confirmAddCondition() {
    const durationType = document.getElementById('duration-type').value;
    const durationValue = document.getElementById('duration-value').value;
    const source = document.getElementById('condition-source').value;
    const notes = document.getElementById('condition-notes').value;

    try {
        const res = await fetch('/api/conditions/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                condition_id: selectedConditionId,
                duration_type: durationType,
                duration_value: durationValue ? parseInt(durationValue) : null,
                source,
                notes
            })
        });

        const data = await res.json();

        if (data.success) {
            showToast(`‚úÖ ${data.condition.name} ajout√©`, 'success');
            hideAddConditionDialog();
            loadActiveConditions();
        } else {
            showToast(data.error || 'Erreur', 'error');
        }
    } catch (err) {
        console.error('Erreur confirmAddCondition:', err);
        showToast('‚ùå Erreur de connexion', 'error');
    }
}

async function removeConditionPrompt(conditionId, conditionName) {
    if (!confirm(`Retirer la condition "${conditionName}" ?`)) return;

    try {
        const res = await fetch('/api/conditions/remove', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({condition_id: conditionId})
        });

        const data = await res.json();

        if (data.success) {
            showToast(`‚úÖ ${conditionName} retir√©`, 'success');
            loadActiveConditions();
        } else {
            showToast(data.error || 'Erreur', 'error');
        }
    } catch (err) {
        console.error('Erreur removeConditionPrompt:', err);
        showToast('‚ùå Erreur de connexion', 'error');
    }
}

async function clearAllConditions() {
    if (!confirm('Retirer TOUTES les conditions actives ?')) return;

    try {
        const res = await fetch('/api/conditions/clear', {method: 'POST'});
        const data = await res.json();

        if (data.success) {
            showToast('‚úÖ Toutes les conditions retir√©es', 'success');
            loadActiveConditions();
        }
    } catch (err) {
        console.error('Erreur clearAllConditions:', err);
        showToast('‚ùå Erreur', 'error');
    }
}

async function decrementRounds() {
    try {
        const res = await fetch('/api/conditions/decrement_rounds', {method: 'POST'});
        const data = await res.json();

        if (data.success) {
            if (data.expired && data.expired.length > 0) {
                const names = data.expired.map(c => c.name).join(', ');
                showToast(`‚è∞ Conditions expir√©es: ${names}`, 'info');
            } else {
                showToast('‚è≠Ô∏è Round d√©cr√©ment√©', 'info');
            }
            loadActiveConditions();
        }
    } catch (err) {
        console.error('Erreur decrementRounds:', err);
        showToast('‚ùå Erreur', 'error');
    }
}

// Recherche
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('condition-search').addEventListener('input', (e) => {
        const search = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('#conditions-catalog .condition-card');

        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            card.style.display = text.includes(search) ? 'block' : 'none';
        });
    });

    // Charger au d√©marrage
    loadConditions();

    // Actualiser toutes les 10 secondes
    setInterval(loadActiveConditions, 10000);
});

// Fermer dialog en cliquant en dehors
document.getElementById('add-condition-dialog').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideAddConditionDialog();
});
</script>
{% endblock %}
